#@ load("@ytt:data", "data")
apiVersion: v1
kind: Secret
metadata:
  name: tap-tap-install-values
  namespace: tap-install
  annotations:
    kapp.k14s.io/change-group: "tap-install-values"
type: Opaque
stringData:
  #@yaml/text-templated-strings
  tap-values.yml: |
    profile: full

    ceip_policy_disclosed: true

    cnrs:
      domain_name: apps.(@= data.values.base_domain @)
      domain_template: "{{.Name}}-{{.Namespace}}.{{.Domain}}"
      default_tls_secret: (@= data.values.default_tls.namespace @)/(@= data.values.default_tls.secret_name @)

    buildservice:
      kp_default_repository: (@= data.values.registry.server @)/(@= data.values.registry.repository @)/build-service
      kp_default_repository_username: (@= data.values.registry.username @)
      kp_default_repository_password: (@= data.values.registry.password @)
      enable_synced_secrets: true
      exclude_dependencies: true

    supply_chain: (@= data.values.supply_chain.type @)

    ootb_supply_chain_basic:
      registry:
        server: (@= data.values.registry.server @)
        repository: (@= data.values.registry.repository @)
      service_account: (@= data.values.supply_chain.service_account @)
      gitops:
        commit_strategy: direct
        pull_request:
          server_kind: github
          commit_branch: ""
          pull_request_title: "ready for review"
          pull_request_body: "generated by ootb_supply_chain_basic"    

    ootb_supply_chain_testing:
      registry:
        server: (@= data.values.registry.server @)
        repository: (@= data.values.registry.repository @)
      service_account: (@= data.values.supply_chain.service_account @)
      gitops:
        commit_strategy: direct
        pull_request:
          server_kind: github
          commit_branch: ""
          pull_request_title: "ready for review"
          pull_request_body: "generated by ootb_supply_chain_testing"  

    ootb_supply_chain_testing_scanning:
      registry:
        server: (@= data.values.registry.server @)
        repository: (@= data.values.registry.repository @)
      service_account: (@= data.values.supply_chain.service_account @)
      gitops:
        commit_strategy: pull_request
        pull_request:
          server_kind: github
          commit_branch: ""
          pull_request_title: "ready for review"
          pull_request_body: "generated by ootb_supply_chain_testing_scanning"  

    contour:
      envoy:
        service:
          type: LoadBalancer
          externalTrafficPolicy: Local

    tap_gui:
      ingressEnabled: true
      ingressDomain: (@= data.values.base_domain @)
      service_type: ClusterIP
      tls:
        secretName: (@= data.values.default_tls.secret_name @)
        namespace: (@= data.values.default_tls.namespace @)
      app_config:
        kubernetes:
          serviceLocatorMethod:
            type: multiTenant
          clusterLocatorMethods:
          - type: config
            clusters:
            - url: https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}
              name: host
              authProvider: serviceAccount
              serviceAccountToken: ${KUBERNETES_SERVICE_ACCOUNT_TOKEN}
              skipTLSVerify: true
            - url: (@= data.values.run[0].url @)
              name: (@= data.values.run[0].name @)
              authProvider: serviceAccount
              serviceAccountToken: (@= data.values.run[0].token @)
              skipTLSVerify: false
              caData: (@= data.values.run[0].ca @)
        customize:
          custom_name: (@= data.values.custom_name @)
          custom_logo: (@= data.values.custom_logo @)
        app:
          title: (@= data.values.custom_name @)
          baseUrl: https://tap-gui.(@= data.values.base_domain @)
        backend:
          baseUrl: https://tap-gui.(@= data.values.base_domain @)
          cors:
            origin: https://tap-gui.(@= data.values.base_domain @)
        catalog:
          locations:
          - type: url
            target: https://github.com/sample-accelerators/tanzu-java-web-app/blob/main/catalog/catalog-info.yaml
          - type: url
            target: https://github.com/tanzu-end-to-end/spring-sensors-sensor/blob/main/catalog/catalog-info.yaml
          - type: url
            target: https://github.com/sample-accelerators/spring-petclinic/blob/accelerator/catalog/catalog-info.yaml
          - type: url
            target: https://github.com/tanzu-japan/spring-music/blob/tanzu/catalog/catalog-info.yaml
          - type: url
            target: https://github.com/categolj/tap-catalog-info/blob/main/blog-api.yaml
          - type: url
            target: https://github.com/categolj/tap-catalog-info/blob/main/blog-counter.yaml
          - type: url
            target: https://github.com/categolj/tap-catalog-info/blob/main/blog-frontend.yaml
          - type: url
            target: https://github.com/categolj/tap-catalog-info/blob/main/blog-translation.yaml
          - type: url
            target: https://github.com/categolj/tap-catalog-info/blob/main/blog-ui.yaml
        auth:
          environment: development
          session:
            secret: opensesami
          providers:
            oidc:
              development:
                metadataUrl: https://dex.(@= data.values.base_domain @)/.well-known/openid-configuration
                clientId: tap-gui
                clientSecret: tap-gui
                tokenSignedResponseAlg: RS256
                scope: "openid profile email groups offline_access"
                prompt: auto

    accelerator:
      domain: (@= data.values.base_domain @)
      ingress:
        include: true
        enable_tls: true
      tls:
        secret_name: (@= data.values.default_tls.secret_name @)
        namespace: (@= data.values.default_tls.namespace @)
      server:
        service_type: ClusterIP

    metadata_store:
      app_service_type: ClusterIP
      ingress_enabled: "true"
      ingress_domain: (@= data.values.base_domain @)

    scanning:
      metadataStore:
        url: "" #! Disable embedded integration since it's deprecated

    package_overlays:
    - name: buildservice
      secrets:
      - name: buildservice-export-registry-credentials
    - name: cert-manager
      secrets:
      - name: cert-manager-cluster-issuer
      - name: cert-manager-recursive-nameservers
    - name: cnrs
      secrets:
      - name: cnrs-default-tls
      - name: cnrs-autocreate-cluster-domain-claims
      - name: cnrs-slim
    - name: ootb-templates
      secrets:
      - name: ootb-templates-multiple-pipelines
      - name: ootb-templates-cache-workspace
    - name: metadata-store
      secrets:
      - name: metadata-store-ingress-tls
    - name: tap-gui
      secrets:
      - name: tap-gui-permit-mavenartifacts-read

    excluded_packages:
    - grype.scanning.apps.tanzu.vmware.com
    - learningcenter.tanzu.vmware.com 
    - workshops.learningcenter.tanzu.vmware.com
